\begin{figure*}[tp]
  % \input{semantics}
    \begin{mathpar}
    \inferrule{}{ \Sigma, \rho \vdash c \Downarrow \Sigma, c}

    \inferrule{}{\Sigma, \rho \vdash x \Downarrow \Sigma, \rho(x)}

    \inferrule{
      \Sigma, \rho \vdash e \Downarrow \Sigma', \Loc \\
      \Sigma' (\Loc) = (\rho, \ilam {\Multi[i]{\kvar}}{\Multi[j]{\tvar}}Ckx{e}) \\
      \Sigma'' =  \IF{\entail C {\kaff \le k}}{\Sigma'[\Loc\mapsto\blob]}{ \Sigma'} \\
      \Loc'\notin\Dom{\Sigma''}  \\
      \Sigma''' = \Sigma''[\Loc' \mapsto (\rho, \subst{\Multi[j]{\tvar}}{\Multi[j]{t}}{\subst {\Multi[i]{\kvar}}{\Multi[i]{k}}{(\lam[k]xe)}}) ]
    }{\Sigma, \rho \vdash  \ivar e{\Multi[i]{k}}{\Multi[j]{\tau}}  \Downarrow \Sigma''', \Loc'
    }

    \inferrule{
      \Loc\notin\Dom\Sigma \\
      \Sigma' = \Sigma[\Loc \mapsto (\rho, \ilam  {\Multi[i]{\kvar}}{\Multi[j]{\tvar}}Ck xe)]
    }{
      \Sigma, \rho \vdash \ilam  {\Multi[i]{\kvar}}{\Multi[j]{\tvar}}Ck xe \Downarrow \Sigma', \Loc
    }
    
    \inferrule{
      \Sigma, \rho \vdash e \Downarrow \Sigma', \Loc \\
      \Sigma' (\Loc) = (\rho'',\lam[k]{x}{e''}) \\
      \Sigma'' = \IF{\entail {} {\kaff \le k}}{ \Sigma'[\Loc\mapsto\blob]}{\Sigma'}\\
      \Sigma'', \rho \vdash e' \Downarrow \Sigma''', r' \\
      \Sigma''', \rho''[x\mapsto r'] \vdash e'' \Downarrow \Sigma'''', r
    }{\Sigma, \rho \vdash \app{e}{e'} \Downarrow \Sigma'''', r}

    \inferrule{
      \Sigma, \rho \vdash e \Downarrow \Sigma', r \\
      \Sigma', \rho[x \mapsto r] \vdash e' \Downarrow \Sigma'', r'
    }{
      \Sigma, \rho \vdash \letin{x}{e}{e'} \Downarrow \Sigma'', r'
    }

    \inferrule{
      \Sigma, \rho \vdash e \Downarrow \Sigma', r \\
      \Sigma', \rho \vdash e' \Downarrow \Sigma'', r' \\
      \Loc\notin\Dom{\Sigma''} \\
      \Sigma''' = \Sigma''[\Loc \mapsto \introPair[k]r{ r'}]
    }{
      \Sigma, \rho \vdash \introPair[k]{e}{e'} \Downarrow \Sigma''', \Loc
    }

    \inferrule{
      \Sigma, \rho \vdash e \Downarrow \Sigma', \Loc \\
      \Sigma' (\Loc) = \introPair[k]r{ r'} \\
      \Sigma'' = \IF{\entail {} {\kaff \le
          k}}{\Sigma'[\Loc\mapsto\blob]}{\Sigma} \\
      \Sigma'', \rho[x,y \mapsto r, r'] \vdash e' \Downarrow \Sigma''', r''
    }{
      \Sigma, \rho \vdash \matchin{x,y}{e}{e'} \Downarrow  \Sigma''', r''
    }

    \inferrule{
      \rho (x) = \alpha \\
      \Sigma (\alpha) = W \\
      (\Sigma\setminus\alpha)[\borrow{\alpha} \mapsto W], \rho \vdash e
      \Downarrow \Sigma', r \\
      \Sigma' (\borrow\alpha) = W' \\
      \Sigma'' = (\Sigma' \setminus\borrow{\alpha})[\alpha \mapsto W']
    }{
      \Sigma, \rho \vdash \region{x}{e} \Downarrow \Sigma', r
    }

    \inferrule{\rho (x) = \alpha}{
      \Sigma, \rho \vdash \borrow{x} \Downarrow \Sigma, \borrow\alpha
    }
    \\
    \inferrule{
      \Sigma, \rho \vdash e \Downarrow \Sigma', r\\
      \Loc\notin \Dom{\Sigma'} }{
      \Sigma,\rho \vdash \create e \Downarrow \Sigma'[\Loc \mapsto \rss{r}], \Loc
    }

    \inferrule{
      \Sigma, \rho \vdash e \Downarrow \Sigma', \Loc \\
      \Sigma' (\Loc) = \rss{r}
    }{
      \Sigma, \rho \vdash \destroy e \Downarrow \Sigma'[\Loc\mapsto \blob], ()
    }

    \inferrule{
      \Sigma, \rho \vdash e \Downarrow \Sigma', \borrow\alpha \\
      \Sigma' (\borrow\alpha) = \rss{r}
    }{
      \Sigma, \rho \vdash \observe e \Downarrow \Sigma', r
    }

    \inferrule{
      \Sigma, \rho \vdash e \Downarrow \Sigma', \borrow[m]\alpha \\
      \Sigma', \rho \vdash e' \Downarrow \Sigma'', r' \\
      \Sigma'' (\borrow[m]\alpha) = \rss{r} \\
      \Sigma''' = \Sigma''[\borrow[m]\alpha \mapsto r']
    }{
      \Sigma, \rho \vdash \update e {e'} \Downarrow \Sigma''', ()
    }

  \end{mathpar}
  \caption{Reduction rules -- $\Sigma, \rho \vdash e \Downarrow
    \Sigma', r$ }
  \label{fig:reduction}
\end{figure*}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
