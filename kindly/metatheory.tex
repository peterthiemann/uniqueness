\clearpage{}
\section{Metatheory}
\label{sec:metatheory}

\lstMakeShortInline[style=rule]@

We are interested in several connections between the type system and
the operational semantics. The type soundness result states
that the semantics returns values of the form predicted by the type
system. It makes use of several standard notions like store typing
$\vdash \Store : \SE$ and agreement of the results in the value environment
with the type environment $\SE \vdash \VEnv:\E$ that we define
formally in the appendix~\cref{sec:metatheory:proofs}. The
non-standard part is the handling of permissions. With
$\Addresses\Perm$ we extract the underlying raw locations from the
permissions and with $\Reach\Store\VEnv$ we transitively trace the
addresses reachable from $\VEnv$ in store $\Store$. We write
$\SE\le\SE'$ and $\Store \le \Store'$ for extending the domain of the
store type and of the store, respectively.

\begin{theorem}
  Suppose that
  \begin{itemize}
  \item $\inferS{C}{\E}{e}{\tau}$
  \item $\SE \vdash \VEnv : \E$
  \item $\vdash \Store : \SE$
  \item $\Addresses\Perm \subseteq \Dom\Store$
  \item $\Reach\Store{\VEnv} \subseteq \Perm$
  \item  $i\in\Nat$ and
    $R = $@eval delta pi gamma i e@
    with $R\ne \TimeOut$.
  \end{itemize}
  Then,
  $\exists$ $\Store'$, $\Perm'$, $r'$, $\SE'$ such that
  \begin{itemize}
  \item
    $R = \Ok{\Store', \Perm', r'}$  
  \item $\SE \le \SE'$, $\Store \le \Store'$,
    $\vdash \Store' : \SE'$ 
  \item $\SE' \vdash r' : \tau$
  \item $\Addresses{\Perm'} \subseteq \Dom{\Store'}$
  \item $\Reach{\Store'}{r'} \subseteq \Perm'$
  \end{itemize}
\end{theorem}


We write $\Writeable\SE\Loc$ to express that the type of location
$\Loc$ permits changing its content. For example,
\begin{itemize}
\item if $\SE (\Loc) =
  \forall\Multi\kvar\forall\Multi{\bvar{\alpha}{k}}.(\qual{C}{\tau_2\tarr{k}\tau_1})$,
  then $\Loc$ is not writeable.
\item if $\SE (\Loc) = \tau_2\tarr{\kun}{\tau_1}$, then $\Loc$ is not
  writeable.
\item if $\SE (\Loc) = \tyPair[\kun]{\tau_1}{\tau_2}$, then $\Loc$ is not writeable.
\item if $\SE (\Loc) = \tapp{t}{\Multi\tau}$, then $\Loc$ is
  writeable. (IT RATHER SEEMS LIKE $\Loc$'s DECENDANT IS WRITEABLE)
\item if $\SE (\Loc) = \borrow\tau$, then \dots (THAT SHOULDN'T REALLY
  BE A STORE TYPE)
\end{itemize}
We write $\Linear\SE\Loc$ to express that $\Loc$ points to a linear
resource.
\begin{itemize}
\item if $\SE (\Loc) =
  \forall\Multi\kvar\forall\Multi{\bvar{\alpha}{k}}.(\qual{C}{\tau_2\tarr{k}\tau_1})$,
  then $\Loc$ is $\dots$
\item if $\SE (\Loc) = \tau_2\tarr{k}{\tau_1}$ and $\Cleq{\klin}{k}$, then $\Loc$ is linear.
\item if $\SE (\Loc) = \tyPair[k]{\tau_1}{\tau_2}$ and $\Cleq \klin
  k$, then $\Loc$ is linear.
\item if $\SE (\Loc) = \tapp{t}{\Multi\tau}$, then $\Loc$ is linear.
\item if $\SE (\Loc) = \borrow\tau$, then \dots (THAT SHOULDN'T REALLY
  BE A STORE TYPE)
\end{itemize}
We write $\Affine\SE\Loc$ to express that $\Loc$ points to an affine
resource.
\begin{itemize}
\item if $\SE (\Loc) =
  \forall\Multi\kvar\forall\Multi{\bvar{\alpha}{k}}.(\qual{C}{\tau_2\tarr{k}\tau_1})$,
  then $\Loc$ is $\dots$
\item if $\SE (\Loc) = \tau_2\tarr{k}{\tau_1}$ and $\Cleq{\kaff}{k}$, then $\Loc$ is affine.
\item if $\SE (\Loc) = \tyPair[k]{\tau_1}{\tau_2}$ and $\Cleq \kaff
  k$, then $\Loc$ is affine.
\item if $\SE (\Loc) = \tapp{t}{\Multi\tau}$, then $\Loc$ is affine.
\item if $\SE (\Loc) = \borrow[\MBORROW]\tau$, then $\Loc$ is affine
  \dots (THAT SHOULDN'T REALLY  BE A STORE TYPE)
\item if $\SE (\Loc) = \borrow[\IBORROW]\tau$, then $\Loc$ is not affine
  \dots (THAT SHOULDN'T REALLY  BE A STORE TYPE)
\end{itemize}
TODO consider using a multiset for $\Reach\Store{}$. For a multiset
$M$, let $\MultiNumber x M$ be the number of times $x$ occurs in $M$.
\clearpage{}
\begin{theorem}
  Suppose that
  \begin{itemize}
  \item $\inferS{C}{\E}{e}{\tau}$
  \item $\SE \vdash \VEnv : \E$
  \item $\vdash \Store : \SE$
  \item $\Addresses\Perm \subseteq \Dom\Store$
  \item $\Reach\Store{\Active\VEnv, \MutableBorrows\VEnv, \ImmutableBorrows\VEnv} \subseteq \Perm$
  % \item  $\VEnv'$ with $\Addresses{\VEnv'}
  %   \subseteq \Dom\Store$ and $\Dom\VEnv \cap \Dom{\VEnv'}=\emptyset$
  \item Incoming Resources: Let $\REACH = \Reach\Store\VEnv$.
    \begin{itemize}
    \item 
      For all $\Loc$ such that $\MultiNumber\Loc{\Reach{\Store}{\Active\VEnv}} >0$,
      if $\Affine{\SE}\Loc$ then $\MultiNumber\Loc\REACH= 1$
    \item For all $\Loc$ such that $
      \MultiNumber\Loc{\Reach{\Store}{\MutableBorrows\VEnv}} >0$, it
      must be that $\MultiNumber\Loc\REACH=1$.
    \item For all $\Loc$ such that $
      \MultiNumber\Loc{\Reach{\Store}{\Suspended\VEnv}} >0$, it
      must be that $\MultiNumber\Loc\REACH=1$.
    \end{itemize}
  \item  $i\in\Nat$ and $\Store, \Perm, \VEnv \vdash {e}
    \Downarrow^i R$ and $R\ne \TimeOut$.
  \end{itemize}
  Then,
  $\exists$ $\Store'$, $\Perm'$, $r'$, $\SE'$ such that
  \begin{itemize}
  \item
    $R = \Ok{\Store', \Perm', r'}$  
  \item $\SE \le \SE'$, $\Store \le \Store'$,
    $\vdash \Store' : \SE'$ 
  \item $\Addresses{\Perm'} \subseteq \Dom{\Store'}$
  \item $\SE' \vdash r' : \tau$
  \item $\Reach{\Store'}{r'} \subseteq \Perm'$
  \item Outside: For all $\Loc \in \Dom{\Store} \setminus
    \Reach{\Store'}{\VEnv}$ it must be that 
    $\Store' (\Loc) = \Store (\Loc)$
    and $\Loc\in\Perm \Leftrightarrow \Loc\in\Perm'$.
    %% must be \Store because \Perm has no idea of \Perm'
  \item Immutables: For all $\Loc \in
    \Reach{\Store'}{\ImmutableBorrows\VEnv}$ it must be that
    $\Loc\in\Dom\Store$, 
    $\Store' (\Loc) = \Store (\Loc)$
    and $\Loc\in\Perm \Leftrightarrow \Loc\in\Perm'$.
  \item Resources:
    Let $\REACH' =\Reach{\Store'}{\Active\VEnv}$.
    For all $\Loc$ such that $n= \MultiNumber\Loc\REACH >0$ and $n' =
    \MultiNumber\Loc{\REACH'}$, 
    \begin{itemize}
    \item if $\Affine{\SE}\Loc$ then $n=1$ and $n'\le 1$,
    \item if $\Linear{\SE}\Loc$ then $n=1$ and $n' = 0$,
    \item if $n'=0$, then $\Loc\notin\Perm'$.
    \end{itemize}
  \item Immutables: For all $\Loc \in \Reach
    {\Store'}{\Active\VEnv}$, if $\neg\Writeable{\SE}\Loc$ then
    $\Store' (\ell) = \Store (\ell)$ and $\Loc\in \Perm'$.
  \item No thin air permission: For all $\Loc\in \Perm'$, $\Loc
    \in \Perm \cup  \Dom{\Store'} \setminus \Dom{\Store}$.
  \end{itemize}
\end{theorem}

\lstDeleteShortInline@


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
