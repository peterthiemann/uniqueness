\clearpage{}
\section{Metatheory}
\label{sec:metatheory}

\begin{itemize}
\item Borrow compatibility
  $\Multi\MBORROW\Multi\IBORROW \Bcompatible \BORROW$,
  \begin{mathpar}
  \inferrule{}{
    \Multi\MBORROW\Multi\IBORROW\IBORROW \Bcompatible \IBORROW
  }

  \inferrule{}{
    \Multi\MBORROW\MBORROW \Bcompatible \MBORROW
  }
  \end{mathpar}
\item Store typing $ \vdash \Store : \SE$,
  \begin{mathpar}
    \inferrule{
      (\forall \Loc \in \Dom\Store)~
      \vdash \Store (\Loc) : \SE (\Loc)
    }{ \vdash \Store : \SE }
  \end{mathpar}
\item Relating storables to type schemes $\SE \vdash W : \schm$
  \begin{mathpar}
  \inferrule{
    (\exists \E)~ \SE \vdash \VEnv : \E
    \\
    \inferS{C}{\E, (x:\tau_2)}{e}{\tau_1}
  }{
    \SE \vdash (\VEnv, \ilam {\Multi\kvar}{\Multi\tvar}Ckx{e})
    : \forall\Multi\kvar\forall\Multi{\bvar{\alpha}{k}}.(\qual{C}{\tau_2\tarr{k}\tau_1})
  }
  \end{mathpar}
\item Relating storables to types $ \SE \vdash W : \tau$
  \begin{mathpar}
    \inferrule{
      (\exists \E, C)~ \SE \vdash \VEnv : \E
      \\
      \inferS{C}{\E, (x:\tau_2)}{e}{\tau_1}
    }{
      \SE \vdash (\VEnv, \lam[k]xe) : \tau_2\tarr{k}\tau_1
    }

    \inferrule{
      \SE \vdash r_1 : \tau_1 \\
      \SE \vdash r_2 : \tau_2
    }{
      \SE \vdash \introPair[k]{r_1}{r_2} : \tau_1\times \tau_2
    }

    \inferrule{
      \SE \vdash r : \IType{t}{\tau^*}
    }{
      \SE \vdash {[r]} : \tapp{t}{\tau^*}
    }

    \inferrule{}{
      \SE \vdash \blob : \tau
    }
  \end{mathpar}
\item Relating  results to types $ \SE \vdash r : \tau$, 
\item Relating results to type schemes $\SE \vdash r : \schm$
  \begin{mathpar}
  \inferrule{}{ \SE \vdash c : \CType{c} }

  \inferrule{}{ \SE \vdash \ell : \SE (\ell) }

  \inferrule{
    \Multi\MBORROW\Multi\IBORROW \Bcompatible \BORROW \\
    \SE \vdash \Loc  : \tau
  }{  \SE \vdash
    \Loc\Multi\MBORROW\Multi\IBORROW : \borrow{\tau}}
  \end{mathpar}
\item Relating environments to contexts
  $\SE \vdash \VEnv : \E$
\end{itemize}
\begin{mathpar}
  \inferrule{}{\SE \vdash \Sempty : \Eempty}

  \inferrule{\SE \vdash \VEnv : \E \\ \SE \vdash r : \schm}
  {\SE \vdash \VEnv[ x\mapsto r] : \E[x \mapsto \schm] }
\end{mathpar}

We write $\Addresses{\VEnv}$ for the function that extracts addresses
from the domain of the variable environment. 

\begin{theorem}
  Suppose that
  \begin{itemize}
  \item $\inferS{C}{\E}{e}{\tau}$
  \item $\SE \vdash \VEnv : \E$
  \item $\vdash \Store : \SE$
  \item $\Perm \subseteq \Dom\Store$
  \item $\Addresses{\VEnv} \subseteq \Perm$
  \end{itemize}
  Then, forall $i\in\Nat$, 
  \begin{itemize}
  \item $\Store, \Perm, \VEnv \vdash {e} \Downarrow^i R$
    where either $R=\TimeOut$ or $R = \Ok{\Store', \Perm', r'}$
  \item $\SE \le \SE'$, $\Store \le \Store'$, $\vdash \Store' : \SE'$
  \item $\Perm' \subseteq \Dom{\Store'}$
  \item $\SE' \vdash r' : \tau$
  \item If $r' = \Loc'$ then $\Loc' \in \Perm'$
  \end{itemize}
\end{theorem}
    
\begin{proof}
  The proof is by induction on $i$.
  The base case is trivial as $\Store, \Perm, \VEnv \vdash {e}
  \Downarrow^0 \TimeOut$.

  For indexes greater than zero we have a case distinction over all applicable execution
  rules.

  \textbf{Case }$\ruleSConst$.
  The claim is immediate.

  \textbf{Case }$\ruleSVar$.
  The claim is immediate.

  \textbf{Case }$\ruleSTApp$.
  
  By assumption, we have that $\SE \vdash \Loc : \E (x)$ so that
  $\E(x) =
  \forall\kvar^*\forall\bvar{\alpha}{k}^*.(\qual{C}{\tau_2\tarr{k}\tau_1})$.
  All conclusions hold: $\SE \le \SE' = \SE[\Loc' \mapsto
  (\tau_2\tarr{k}\tau_1)[\Multi{\kvar_i} \mapsto \Multi{ k_i},
  \Multi{\alpha_j} \mapsto \Multi{t_j}]]$;
  $\vdash \Store' : \SE'$;
  $\Perm' \subseteq \Dom{\Store'}$;
  $\DE' \vdash \Loc' : \tau$;
  and $\Loc' \in \Perm' \Sadd{\Loc'}$.

  \textbf{Case }$\ruleSPLam$.

  By assumption $\SE \vdash     \ilam {\Multi[i]{\kvar}}{\Multi[j]{\tvar}}Ck xe
  : \schm$ where $\schm =
  \forall\Multi\kvar\forall\Multi{\bvar{\alpha}{k}}.(\qual{C}{\tau_2\tarr{k}\tau_1})$. Let
  $\SE'  = \SE[\Loc \mapsto \schm]$.
  Then $\SE \le \SE'$ and $\vdash\Store' : \SE'$.
  Moreover, $\SE' \vdash \Loc : \schm$ and $\Loc \in \Perm
  \Sadd{\Loc}$ as required.

  \textbf{Case }$\ruleSApp$.

  \textbf{Case }$\ruleSLet$.

  \textbf{Case }$\ruleSPair$.

  \textbf{Case }$\ruleSMatchLocation$.

  \textbf{Case }$\ruleSMatchBorrow$.

  \textbf{Case }$\ruleSRegion$.

  \textbf{Case }$\ruleSBorrow$.

  \textbf{Case }$\ruleSCreate$.

  \textbf{Case }$\ruleSDestroy$.

  \textbf{Case }$\ruleSObserve$.

  \textbf{Case }$\ruleSUpdate$.
\end{proof}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
