\clearpage{}
\section{Metatheory}
\label{sec:metatheory}

\lstMakeShortInline[style=rule]@

We are interested in several connections between the type system and
the operational semantics. The type soundness result states
that the semantics returns values of the form predicted by the type
system. It makes use of several standard notions like store typing
$\vdash \Store : \SE$ and agreement of the results in the value environment
with the type environment $\SE \vdash \VEnv:\E$ that we define
formally in~\cref{sec:metatheory:proofs} along with selected cases of the proofs. The
non-standard part is the handling of permissions. With
$\Addresses\Perm$ we extract the underlying raw locations from the
permissions and with $\Reach\Store\VEnv$ we transitively trace the
addresses reachable from $\VEnv$ in store $\Store$. We write
$\SE\le\SE'$ and $\Store \le \Store'$ for extending the domain of the
store type and of the store, respectively.

\begin{theorem}[Type Soundness]\label{theorem:type-soundness}
  Suppose that
  \begin{itemize}
  \item $\inferS{C}{\E}{e}{\tau}$
  \item $\SE \vdash \VEnv : \E$
  \item $\vdash \Store : \SE$
  \item $\Addresses\Perm \subseteq \Dom\Store$
  \item $\Reach\Store{\VEnv} \subseteq \Perm$
  \item  $i\in\Nat$ and
    $R = $@eval delta pi gamma i e@
    with $R\ne \TimeOut$.
  \end{itemize}
  Then,
  $\exists$ $\Store'$, $\Perm'$, $r'$, $\SE'$ such that
  \begin{itemize}
  \item
    $R = \Ok{\Store', \Perm', r'}$  
  \item $\SE \le \SE'$, $\Store \le \Store'$,
    $\vdash \Store' : \SE'$ 
  \item $\SE' \vdash r' : \tau$
  \item $\Addresses{\Perm'} \subseteq \Dom{\Store'}$
  \item $\Reach{\Store'}{r'} \subseteq \Perm'$
  \end{itemize}
\end{theorem}

Further bookkeeping is needed to demonstrate the substructural
properties. The permission set is the first set. It contains the set
of addresses that can be used during evaluation. It is managed by the
region expression as well as by creation and use of resources as
shown in \cref{sec:sem}.

For the refined statement, we distinguish several parts of the value
environment $\VEnv$ that correspond to the different kinds of bindings in the
type environment: $\Active\VEnv$ for the active entries of direct
references to resources, closures, etc; $\MutableBorrows\VEnv$ for the
affine borrows; $\ImmutableBorrows\VEnv$ for the unrestricted borrows;
and $\Suspended\VEnv$ for suspended entries. Indeed, the judgment
$\SE \vdash \VEnv:\E$ is already defined in terms of this structure.
Moreover, to properly discuss linearity and affinity, we treat
$\Reach\Store\VEnv$ as a multiset. For a multiset
$M$, we use the notation $\MultiNumber x M$ for the number of times $x$ occurs in $M$.


With these concepts, we can refine the assumption of
\cref{theorem:type-soundness} by two items:
\begin{itemize}
\item $\Reach\Store{\Active\VEnv, \MutableBorrows\VEnv, \ImmutableBorrows\VEnv} \subseteq \Perm$
  % \item  $\VEnv'$ with $\Addresses{\VEnv'}
  %   \subseteq \Dom\Store$ and $\Dom\VEnv \cap \Dom{\VEnv'}=\emptyset$
\item Incoming Resources: Let $\REACH = \Reach\Store\VEnv$.
  \begin{itemize}
  \item 
    For all $\Loc$ such that $\MultiNumber\Loc{\Reach{\Store}{\Active\VEnv}} >0$,
    if $\Affine{\SE}\Loc$ then $\MultiNumber\Loc\REACH= 1$
  \item For all $\Loc$ such that $
    \MultiNumber\Loc{\Reach{\Store}{\MutableBorrows\VEnv}} >0$, it
    must be that $\MultiNumber\Loc\REACH=1$.
  \item For all $\Loc$ such that $
    \MultiNumber\Loc{\Reach{\Store}{\Suspended\VEnv}} >0$, it
    must be that $\MultiNumber\Loc\REACH=1$.
  \end{itemize}
\end{itemize}
Thus, we do not require permission for suspended bindings in the
environment. Moreover, affine (or linear)  resources, affine
borrows, and suspended bindings must be reached exactly once by
incoming references. I.e., there is no restriction on unrestricted
borrows and other resources. The function $\Affine{\SE}\Loc$ checks
affinity of a resource by inspecting the store type (see
\cref{sec:metatheory:proofs}). 

This refined assumption enables the following additional conclusions,
again stated in the context of \cref{theorem:type-soundness}.
\begin{itemize}
\item Outside: For all $\Loc \in \Dom{\Store} \setminus
  \Reach{\Store'}{\VEnv}$ it must be that 
  $\Store' (\Loc) = \Store (\Loc)$
  and $\Loc\in\Perm \Leftrightarrow \Loc\in\Perm'$.
  %% must be \Store because \Perm has no idea of \Perm'
\item Immutables: For all $\Loc \in
  \Reach{\Store'}{\ImmutableBorrows\VEnv}$ it must be 
  $\Loc\in\Dom\Store$, 
  $\Store' (\Loc) = \Store (\Loc)$
  and $\Loc\in\Perm \Leftrightarrow \Loc\in\Perm'$.
\item Resources:
  Let $\REACH' =\Reach{\Store'}{\Active\VEnv}$.
  For all $\Loc$ such that $n= \MultiNumber\Loc\REACH >0$ and $n' =
  \MultiNumber\Loc{\REACH'}$, 
  \begin{itemize}
  \item if $\Affine{\SE}\Loc$ then $n=1$ and $n'\le 1$,
  \item if $\Linear{\SE}\Loc$ then $n=1$ and $n' = 0$,
  \item if $n'=0$, then $\Loc\notin\Perm'$.
  \end{itemize}
\item ReadOnly: For all $\Loc \in \Reach
  {\Store'}{\Active\VEnv}$, if $\neg\Writeable{\SE}\Loc$ then
  $\Store' (\ell) = \Store (\ell)$ and $\Loc\in \Perm'$.
\item No thin air permission: For all $\Loc\in \Perm'$, $\Loc
  \in \Perm \cup  \Dom{\Store'} \setminus \Dom{\Store}$.
\end{itemize}
Functions $\Linear{\SE}\Loc$ and $\Writeable\SE\Loc$ are defined analogously to
$\Affine{\SE}\Loc$. Intuitively, 

%%% !!!! TBC !!!!

\clearpage{}
\begin{theorem}
  Suppose that
  \begin{itemize}
  \item $\inferS{C}{\E}{e}{\tau}$
  \item $\SE \vdash \VEnv : \E$
  \item $\vdash \Store : \SE$
  \item $\Addresses\Perm \subseteq \Dom\Store$
  \item $\Reach\Store{\Active\VEnv, \MutableBorrows\VEnv, \ImmutableBorrows\VEnv} \subseteq \Perm$
  % \item  $\VEnv'$ with $\Addresses{\VEnv'}
  %   \subseteq \Dom\Store$ and $\Dom\VEnv \cap \Dom{\VEnv'}=\emptyset$
  \item Incoming Resources: Let $\REACH = \Reach\Store\VEnv$.
    \begin{itemize}
    \item 
      For all $\Loc$ such that $\MultiNumber\Loc{\Reach{\Store}{\Active\VEnv}} >0$,
      if $\Affine{\SE}\Loc$ then $\MultiNumber\Loc\REACH= 1$
    \item For all $\Loc$ such that $
      \MultiNumber\Loc{\Reach{\Store}{\MutableBorrows\VEnv}} >0$, it
      must be that $\MultiNumber\Loc\REACH=1$.
    \item For all $\Loc$ such that $
      \MultiNumber\Loc{\Reach{\Store}{\Suspended\VEnv}} >0$, it
      must be that $\MultiNumber\Loc\REACH=1$.
    \end{itemize}
  \item  $i\in\Nat$ and $\Store, \Perm, \VEnv \vdash {e}
    \Downarrow^i R$ and $R\ne \TimeOut$.
  \end{itemize}
  Then,
  $\exists$ $\Store'$, $\Perm'$, $r'$, $\SE'$ such that
  \begin{itemize}
  \item
    $R = \Ok{\Store', \Perm', r'}$  
  \item $\SE \le \SE'$, $\Store \le \Store'$,
    $\vdash \Store' : \SE'$ 
  \item $\Addresses{\Perm'} \subseteq \Dom{\Store'}$
  \item $\SE' \vdash r' : \tau$
  \item $\Reach{\Store'}{r'} \subseteq \Perm'$
  \item Outside: For all $\Loc \in \Dom{\Store} \setminus
    \Reach{\Store'}{\VEnv}$ it must be that 
    $\Store' (\Loc) = \Store (\Loc)$
    and $\Loc\in\Perm \Leftrightarrow \Loc\in\Perm'$.
    %% must be \Store because \Perm has no idea of \Perm'
  \item Immutables: For all $\Loc \in
    \Reach{\Store'}{\ImmutableBorrows\VEnv}$ it must be that
    $\Loc\in\Dom\Store$, 
    $\Store' (\Loc) = \Store (\Loc)$
    and $\Loc\in\Perm \Leftrightarrow \Loc\in\Perm'$.
  \item Resources:
    Let $\REACH' =\Reach{\Store'}{\Active\VEnv}$.
    For all $\Loc$ such that $n= \MultiNumber\Loc\REACH >0$ and $n' =
    \MultiNumber\Loc{\REACH'}$, 
    \begin{itemize}
    \item if $\Affine{\SE}\Loc$ then $n=1$ and $n'\le 1$,
    \item if $\Linear{\SE}\Loc$ then $n=1$ and $n' = 0$,
    \item if $n'=0$, then $\Loc\notin\Perm'$.
    \end{itemize}
  \item Immutables: For all $\Loc \in \Reach
    {\Store'}{\Active\VEnv}$, if $\neg\Writeable{\SE}\Loc$ then
    $\Store' (\ell) = \Store (\ell)$ and $\Loc\in \Perm'$.
  \item No thin air permission: For all $\Loc\in \Perm'$, $\Loc
    \in \Perm \cup  \Dom{\Store'} \setminus \Dom{\Store}$.
  \end{itemize}
\end{theorem}

\lstDeleteShortInline@


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
