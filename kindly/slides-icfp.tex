\documentclass[aspectratio=169,dvipsnames,svgnames,10pt]{beamer}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[french, english]{babel}
\selectlanguage{english}

\usepackage{graphicx}

% Math
\usepackage{amsmath}
% \usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
% \usepackage{mathrsfs}
\usepackage{mathtools}
\usepackage{textcomp}
% \usepackage{textgreek}

% Specialized packages
% \usepackage{syntax} % Grammar definitions
\usepackage{verbatim}
\usepackage{listings} % Code
\usepackage{xspace} % Useful for macros
\usepackage{natbib}% Good citations and bibliography
\usepackage{mathpartir} % Syntax trees
\usepackage{colortbl}
\usepackage{hhline}
\usepackage{multicol}%multicolumn lists
\usepackage{pifont}%% check mark
\usepackage{minted}
\usepackage{wasysym}

% \usepackage{mathptmx}
% \usepackage[scaled=0.9]{helvet}
\usepackage{beramono}

\bibliographystyle{ACM-Reference-Format}
\citestyle{acmauthoryear}
\usepackage{appendixnumberbeamer}

\usetheme{metropolis}
\beamertemplatenavigationsymbolsempty
\setbeamercovered{transparent=20}
\metroset{
  sectionpage=none,
  numbering=fraction,
  progressbar=foot,
}

\usepackage{tikz}
\usetikzlibrary{decorations.text,backgrounds,positioning,shapes,
  shadings,shadows,arrows,decorations.markings,calc,fit,fadings,
  tikzmark,scopes
}
\input{tikz}

\def\HUGE{\fontsize{35pt}{15pt}\selectfont}

\input{prelude}
\input{caml}
\input{notations}
\input{rulemacros}


\newcommand\Y{{\color{Green}{\ding{52}}}}
\newcommand\N{{\color{Red}{\ding{56}}}}
\newcommand\M{{\color{Orange}{\textasciitilde}}}

\lstset{
  tabsize=4,
  aboveskip={0.5\baselineskip},
  belowcaptionskip=0.5\baselineskip,
  basicstyle=\scriptsize\ttfamily,
}

\title{Kindly Bent To Free Us}
\author{\textbf{Gabriel \textsc{Radanne}}
  \and Hannes \textsc{Saffrich}
  \and Peter \textsc{Thiemann}}

\begin{document}

\lstMakeShortInline[keepspaces,basicstyle=\small\ttfamily]@

\frame[plain]{\titlepage}


\begin{frame}
  \frametitle{Motivation}

  Memory safety is the cause of numerous bugs and security issues.
  
  Recent classification (2015-2020) of \og high severity security bugs\fg in Chromium:

  \begin{figure}[h]
    \centering
    \includegraphics[width=0.55\textwidth]
    {chromium-use-after-free}
  \end{figure}

  \pause
  Chromium is written in C/C++!\\
  Surely these bugs don't happen in high-level typed languages\alt<3>{ \dots right?}{.}
  
\end{frame}

\begin{frame}[fragile]
  \frametitle{Let's write some OCaml code}

\begin{minted}{OCaml}
let db : database = Dbm.opendbm "mydb" [Dbm_rdwr] 0o666 in
Dbm.add db "hello" 42;
(* ... *)
Dbm.close db;
(* ... *)
print_int (Dbm.find db "hello") (* bug! *)
\end{minted}
  
\end{frame}

\begin{frame}
  \frametitle{Solutions?}

  Existing ways to solve this
  
\end{frame}

\begin{frame}[fragile]
  \frametitle{Affe!}

  \begin{onlyenv}<1-3>
\begin{minted}[texcomments=true,escapeinside=\#\#]{OCaml}
let db : #\tikzcoord{db1}#database#\tikzcoord{db2}# = Dbm.opendbm "mydb" [Dbm_rdwr] 0o666 in
Dbm.add #\tikzcoord{A1}#&!db#\tikzcoord{A2}# #\tikzcoord{string1}#"hello"#\tikzcoord{string2}# 42;
(* ... *)
Dbm.close db;
(* ... *)
print_int (Dbm.find #\tikzcoord{U1}#&db#\tikzcoord{U2}# "world") (* \N Compile time error! *)
\end{minted}
  \end{onlyenv}
  \begin{onlyenv}<4>
\begin{minted}[texcomments=true,escapeinside=\#\#]{OCaml}
let db #\tikzcoord{eq1}#=#\tikzcoord{eq2}# Dbm.opendbm "mydb" [Dbm_rdwr] 0o666 in
Dbm.add &!db "hello" "world";
(* ... *)
Dbm.close db;
(* ... *)
print_string (Dbm.find &db "hello") (* \N Compile time error! *)
\end{minted}
  \end{onlyenv}
  
  \begin{tikzpicture}[remember picture,overlay]
    \begin{onlyenv}<2>
      \node[code,fit=(db1) (db2)] (db) {};
      \node[code,fit=(string1) (string2)] (string) {};
      \node[overlay,text width=8.7cm,annot,scale=1] at (5,-0.7) {
        \textbf{Kinds determine usage:}
        \begin{itemize}
        \item Linear (@lin@): Used exactly once $[1]$
        \item Affine (@aff@): Used at most once $[0-1]$
        \item Unrestricted (@un@): Used arbitrarily many time $[0-\infty]$
        \end{itemize}
      };
      \draw[overlay,link] (db) to[out=60,in=180]
      +(2,1) node[annot,anchor=west]
      {@type database : lin (* Linear kind *)@};
      \draw[overlay,link] (string) to[out=-30,in=180]
      +(1.5,-0.5) node[annot,anchor=west]
      {@type string : un (* Unrestricted kind *)@};
    \end{onlyenv}
    \begin{onlyenv}<3>
      \node[code,fit=(A1) (A2)] (A) {};
      \node[code,fit=(U1) (U2)] (U) {};
      \node[annot,scale=1.2] at ($(A)+(1.8,-0.8)$) (borrows) {Borrows!};
      \draw[overlay,link] (A) to[out=-30,in=150] (borrows) ;
      \draw[overlay,link] (U) to[out=120,in=-60] (borrows) ;
    \end{onlyenv}
    \begin{onlyenv}<4>
      \node[code,fit=(eq1) (eq2)] (eq) {};
      \draw[overlay,link] (eq) to[out=90,in=-90]
      +(0.5,1) node[annot,scale=1.2,anchor=south]
      {Complete Type Inference};
    \end{onlyenv}
  \end{tikzpicture}
\end{frame}


\begin{frame}{Table of contents}
  \setbeamertemplate{section in toc}[sections numbered]
  \tableofcontents[hideallsubsections]
\end{frame}

\section{Linearity through kinds}

\begin{frame}[fragile]
  \frametitle{Linearity through kinds}
  
  \textbf{Kinds determine usage:}
  \begin{itemize}
  \item Linear (@lin@): Used exactly once $[1]$
  \item Affine (@aff@): Used at most once $[0-1]$
  \item Unrestricted (@un@): Used arbitrarily many time $[0-\infty]$
  \end{itemize}

  \textbf{Examples:}
  \begin{onlyenv}<1>
\begin{minted}[texcomments=true]{OCaml}
type database : lin
type string : un
\end{minted}
  \end{onlyenv}
  \begin{onlyenv}<2>
\begin{minted}[texcomments=true]{OCaml}
type ('a : 'k) list : 'k
\end{minted}
  \end{onlyenv}
  \begin{onlyenv}<3>
\begin{minted}[texcomments=true]{OCaml}
type ('a : 'k) list : 'k
val create_list : ('a : un) => int -> 'a -> 'a list
\end{minted}

    We also use \textbf{kind constraints} and \textbf{subkinding}\\
    $\Rightarrow$ Type signatures are still reasonably simple!
    \TODO{More on subkinding ?}
  \end{onlyenv}
\end{frame}


\section{Functions and captures}

\begin{frame}[fragile]
  \frametitle{Functions and captures}

  What about functions ? We can capture: 
\begin{minted}[texcomments=true,escapeinside=\#\#]{OCaml}
let db = Dbm.open ... 

let #\tikzcoord{fun1}#conclude#\tikzcoord{fun2}# x = 
  Dbm.add &db "conclude" x;
  Dbm.close db
\end{minted}
  \begin{onlyenv}<3->
    We infer the type:
\begin{minted}[texcomments=true,escapeinside=\#\#]{OCaml}
val oups : int #\tikzcoord{arr1}#-{lin}>#\tikzcoord{arr2}# unit
\end{minted}
  \end{onlyenv}

  \begin{tikzpicture}[remember picture,overlay]
    \begin{onlyenv}<2>
      \node[code,fit=(fun1) (fun2)] (fun) {};
      \draw[overlay,link] (fun) to[out=30,in=180]
      +(3,0.5) node[annot,scale=1,anchor=west] {
        This function must behave \textbf{linearly}
      };
    \end{onlyenv}
    \begin{onlyenv}<3->
      \node[code,fit=(arr1) (arr2)] (arr) {};
      \draw[overlay,link] (arr) to[out=-30,in=180]
      +(2,-0.5) node[annot,scale=1,anchor=west] {
        Arrows are annotated with their usage mode
      };
      \node<4>[annot,scale=1.2,red] at ($(arr)+(5,1)$) {
        \textbf{Warning}: This does not say anything about the arguments!!
      };
    \end{onlyenv}
  \end{tikzpicture}
\end{frame}

\section{Borrows and regions}

\begin{frame}[fragile]{Borrows}

\begin{minted}[texcomments=true,escapeinside=\#\#]{OCaml}
let gradeDB = ... in
let grade = Dbm.find #\tikzcoord{U1}#&gradeDB#\tikzcoord{U2}# "compsci" in
Dbm.add #\tikzcoord{A1}#&!gradeDB#\tikzcoord{A2}# "best" grade;
Dbm.close db
\end{minted}
  
  Borrows allow to lend usage of something to someone else.
  \begin{itemize}
  \item \textbf{Shared} borrows \tikzcoord{U3}@&a@\tikzcoord{U4} which are Unrestricted (@un@)
  \item \textbf{Exclusive} borrows \tikzcoord{A3}@&!a@\tikzcoord{A4} which are Affine (@aff@)
  \end{itemize}

  \visible<2>{
    \textbf{There are rules to respect!}
  }
  
  % \textbf{Rules:}
  % \begin{itemize}
  % \item Cannot use a borrow of @a@ and @a@ itself at the same time.
  % \item Only one exclusive borrows at a time
  % \item Borrows must not escape
  % \end{itemize}
  
  \begin{tikzpicture}[remember picture,overlay]
    \node[code,color=yellow,fit=(A1) (A2)] {};
    \node[code,color=red,fit=(U1) (U2)] {};
    \node[code,color=yellow,fit=(A3) (A4)] {};
    \node[code,color=red,fit=(U3) (U4)] {};
  \end{tikzpicture}
\end{frame}


\begin{frame}[fragile]
  \frametitle{Borrows -- Example of uses}
  \begin{onlyenv}<1>
    Good use of borrows:
\begin{minted}[texcomments=true]{OCaml}
let gradeDB = ... in
let avg =
  (Dbm.find &gradeDB "math" + Dbm.find &gradeDB "compsci") / 2
  (* \Y Multiple shared borrows *)
in
Dbm.add &!gradeDB "average" avg (* \Y One exclusive borrow *)
\end{minted}
\end{onlyenv}

% \begin{onlyenv}<2>
% \begin{minted}[texcomments=true]{OCaml}
% let gradeDB = ... in
% let avg =
%  let grade topic = Dbm.find &gradeDB topic in (* \Y Capture *)
%  (grade "math" + grade "compsci") / 2
% in
% Dbm.add &!gradeDB "average" avg (* \Y Exclusive borrow *)
% \end{minted}
% \end{onlyenv}

\begin{onlyenv}<2>
  \textbf{Rule 1}: Cannot use a borrow and the thing itself simultaneously
\begin{minted}[texcomments=true]{OCaml}
let gradeDB = ... in
f (gradeDB, &gradeDB) (* \N Conflicting use and borrow! *)
\end{minted}
\end{onlyenv}
\begin{onlyenv}<3>
  \textbf{Rule 2}: Cannot use an exclusive borrow and any other borrow simultaneously
\begin{minted}[texcomments=true]{OCaml}
let gradeDB = ... in
f (&!gradeDB, &gradeDB) (* \N Conflicting borrows! *)
\end{minted}
\end{onlyenv}
\begin{onlyenv}<4>
  \textbf{Rule 3}: Borrows must not escape
\begin{minted}[texcomments=true]{OCaml}
let f () = 
  let gradeDB = ... in
  let x = (&gradeDb, "mygrades") in
  x (* \N Borrow escaping its scope! *)
\end{minted}
\end{onlyenv}
\end{frame}

\begin{frame}
  \frametitle{Regions/Scoping}
  \TODO{Very quick example of region/scoping}
\end{frame}


% \begin{frame}[fragile]{API}

%   {\Large The \texttt{Dbm} API:}
% \begin{minted}[texcomments=true]{OCaml}
% type database : lin
% val find : &(database,'k) -> string -{'k}> int
% val add : &!(database,'k) -> string -{'k}> int -{'k}> unit
% \end{minted}
  
% \end{frame}

\begin{frame}[fragile]
  \frametitle{Everything together}
  \TODO{Make that straighter/punchier}
  
  \begin{onlyenv}<1>
\begin{minted}[texcomments=true]{OCaml}
let gradeDB = ... in
(Dbm.find &gradeDB "math" + Dbm.find &gradeDB "compsci") / 2
\end{minted}
  \end{onlyenv}
  \begin{onlyenv}<2>
\begin{minted}[texcomments=true]{OCaml}
let gradeDB = ... in
let grade subject = Dbm.find &gradeDB subject in (* \Y Capture *)
(grade "math" + grade "compsci") / 2
\end{minted}
  \end{onlyenv}
  \begin{onlyenv}<3>
\begin{minted}[texcomments=true]{OCaml}
let gradeDB = ... in
let grade = Dbm.find &gradeDB in (* \Y Partial application *)
(grade "math" + grade "compsci") / 2
\end{minted}
  \end{onlyenv}
  \begin{onlyenv}<4->
\begin{minted}[texcomments=true]{OCaml}
(* \Y Easy functional abstraction *)
let average db subjects = 
  List.map (Dbm.find db) subjects / List.length subjects

let main () =
  let gradeDB = ... in
  let avg = average &gradeDB ["math";"compsci";...] in
  Dbm.add &!gradeDB "average" avg
\end{minted}
  \end{onlyenv}
\end{frame}

\section{Inference and constraints}

\begin{frame}[fragile]{Inference and constraints}

\TODO{Show the global step-by-step process}
  
\begin{minted}[texcomments=true]{OCaml}
let average db subjects = 
  List.map (Dbm.find db) subjects / List.length subjects

let main () =
  let gradeDB = ... in
  let avg = {| average &gradeDB ["math";"compsci";...] |} in
  {| Dbm.add &!gradeDB "average" avg |}
\end{minted}
   
\end{frame}

\section*{Conclusion}

\begin{frame}
  \frametitle{Affe -- Recap}
  Recap all the nice properties we showed
\end{frame}

\begin{frame}
  \frametitle{Theory}
  Give the theoretical contributions of the paper
\end{frame}

\begin{frame}
  \frametitle{Conclusion}
  
\end{frame}

\bibliography{biblio}

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-command-extra-options: "-shell-escape"
%%% TeX-master: "slides-icfp"
%%% End:
