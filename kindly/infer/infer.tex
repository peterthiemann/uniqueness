\section{Type inference}

We now formulate type inference for the \lang language. Our inference technique is based on the HM(X) framework~\citep{DBLP:journals/tapos/OderskySW99} which
presents how to merge Hindley-Milner type inference for let-polymorphism and
constraint solving. We first present our constraint language, we then show
our slight extension of HM(X) that support a kind system and affine types.

\subsection{Preliminaries}

\subsubsection{Constraint language}

We consider $\mathcal C$ the set of constrains.
The grammar of constrains, presented
in \cref{grammar:constraint}, follows the traditional HM(X) formulation
with conjunctions,projections and type inequalities. The only new
element specific to our approach are kind equalities.
Entailment is noted $\entail{C}{D}$, where $D$ is a consequence of the
constraints $C$. The entailment rules are provided in \cref{rules:entail}.

\begin{figure}[h]
  \centering
  \begin{align*}
    C ::=&\ \Cleq{\tau_1}{\tau_2}\ |\ \Cleq{k_1}{k_2}\ |\ C_1 \Cand C_2\ |\ \Cproj{\alpha}{C}
  \end{align*}
  \caption{The constraint language}
  \label{grammar:constraint}
\end{figure}

\begin{figure*}[h]
  \input{infer/entails}
  \caption{Entailment rules -- $\entail{C}{D}$ }
  \label{rules:entail}
\end{figure*}


\subsubsection{Solved forms}

The set of solved forms, noted $\mathcal S$,
is the set of constraints than can be used inside
type and kind schemes. $\mathcal S$ is composed only of kind
inequalities \emph{over variables}. For convenience, if $C\in\mathcal S$, we
note $C$ as a list of kind inequalities: $\Cleq{\kvar_i}{\kvar_{i'}}^n$.
\TODO{Extend the properties of solved forms}


We consider the existence of a function $\normalize$ which takes
a constraint in $\mathcal C$ and a unifier $\psi$ and returns a constraint
in solved form $C'$, and an updated unifier.


\subsubsection{Usage maps}

\TODO{Explain $\Sigma$}

\subsection{Kind inference}

We note $\inferK{(C,\unif)}{\bf{\E}}{\bf{\tau}}{k}$ when type $\tau$ has kind $k$
in environment $\E$ under constraints $C$ and unifier $\unif$. From an
algorithmic point of view, $\E$ and $\tau$ are the input parameters of
our inference procedure.
We present the kind inference algorithm as a set of syntax-directed rules in
\cref{rules:kinding}.
Since higher-kinded types are not supported, the type application
rule and the type constructor rule are merged in {\sc KApp}.
Additionally, type variables must be of a simple kind in rule {\sc KVar}.
Note that in the case of a type constructor with no argument, the {\sc KApp}
rule degenerates to a simpler form which is similar to the {\sc KVar} rule.
Kind schemes are instantiated in the {\sc KApp} and {\sc KVar} rules by creating
fresh kind variables and the associated substitution.


\TODO{Explain more?} 


\begin{figure}[h]
  \centering
  \input{infer/kinds}
  \caption{Kind inference rules -- $\inferK{(C,\unif)}{\E}{\tau}{k}$}
  \label{rules:kinding}
\end{figure}


\subsection{Type inference}

We reformulate the HM(X) type inference in the context of our affine type
system. The main difference compared to HM(X) are noted in \addlin{blue}.
We note $\inferW{\addlin{\Sigma}}{(C,\unif)}{\bf{\E}}{\bf{e}}{\tau}$ when
$e$\ as type $\tau$ in $\E$ under the constraints $C$ and unifier $\unif$.
$\Sigma$ is a map which associates free variables in $e$ to
their kinds.
As before, $\E$ and $e$ are the input parameters of the inference
algorithm. The syntax-directed rules are shown in \cref{rules:typing}.

\begin{figure*}[h]
  \input{infer/typing}
  \caption{Type Inference rules -- $\inferW{\Sigma}{(C,\psi)}{\bf{\E}}{\bf{e}}{\tau}$ }
  \label{rules:typing}
\end{figure*}

\subsection{Constraint normalization and generalization}

\TODO{}

\subsection{Principality}

\TODO{}

\begin{itemize}
\item Properly ensure that it respects HM(X) (cylindric, \dots)
\item Show principal type inference:
  \begin{itemize}
  \item Principal constraint system
  \item Regular constraint system: $\Ceq{\tau}{\tau'} \implies \fv{\tau} = \fv{\tau'}$.
  \item Solved forms are in simplified form.
    $C\in S, \entail{C}{\Ceq{\tau}{\tau'}} \implies \entail{}{\Ceq{\tau}{\tau'}}$.
  \end{itemize}
\item Show equivalence with the logic-based system.

\end{itemize}


\begin{lemma}
  Without loss of generality, we can consider that
  kind inequalities in satisfiable constraints
  are only done on kind variables. 

  \begin{proof}
    Consider the constraint $\Cleq{k}{k'}\Cand C$.
    \begin{itemize}
    \item If $k$ and $k'$ are both constants, it can be removed.
    \item If the constraint is $\Cleq{\kvar}{\kaff}$ or $\Cleq{\kun}{\kvar}$, it can be removed.
    \item If the constraint is $\Cleq{\kvar}{\kun}$ or $\Cleq{\kaff}{\kvar}$, we
      can substitute $\kvar$ by its value in $C$.
    \end{itemize}
  \end{proof}
\end{lemma}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../main"
%%% End:
