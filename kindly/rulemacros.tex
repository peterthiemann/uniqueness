\newcommand\ruleTimeOut{%
  \inferrule[TimeOut]{}{\Store, \Perm, \VEnv \vdash e \Downarrow^0 \TimeOut}
}

\newcommand\ruleSConst[1][i]{%
  \inferrule[SConst]{}{ \Store, \Perm, \VEnv \vdash c \Downarrow^{#1+1} \Ok{\Store, \Perm, c}}
}

\newcommand\ruleSVar[1][i]{%
  \inferrule[SVar]{}{\Store, \Perm, \VEnv \vdash x \Downarrow^{#1+1} \Ok{\Store, \Perm, \VEnv(x)}}
}

\newcommand\ruleSTApp[1][i]{%
  \inferrule[STApp]{
    \VEnv (x) = \Loc \\
    \Loc \in \Perm \\
    \Store (\Loc) = (\VEnv, \ilam {\Multi[i]{\kvar}}{\Multi[j]{\tvar}}Ckx{e}) \\
    \Perm' =  \IF{\entail C {k \le \kun}}{ \Perm}{\Perm\Sdel\Loc} \\
    \Loc'\notin\Dom{\Store}  \\
    \Store' = \Store[\Loc' \mapsto (\VEnv, \subst{\Multi[j]{\tvar}}{\Multi[j]{t}}{\subst {\Multi[i]{\kvar}}{\Multi[i]{k}}{(\lam[k]xe)}}) ]
  }{\Store, \Perm, \VEnv \vdash  \ivar x{\Multi[i]{k}}{\Multi[j]{\tau}}
    \Downarrow^{#1+1} \Ok{\Store', \Perm'\Sadd{\Loc'}, \Loc'}
  }
}

\newcommand\ruleSPLam[1][i]{%
  \inferrule[SPLam]{
    \Loc'\notin\Dom\Store \\
    \Store' = \Store[\Loc' \mapsto (\VEnv, \ilam
    {\Multi[i]{\kvar}}{\Multi[j]{\tvar}}Ck xe)] \\
    \Perm' = \Perm\Sadd{\Loc'}
  }{
    \Store, \Perm, \VEnv \vdash
    \ilam {\Multi[i]{\kvar}}{\Multi[j]{\tvar}}Ck xe
    \Downarrow^{#1+1} \Ok{ \Store', \Perm', \Loc'}
  }
}

\newcommand\ruleSApp[1][i]{%
  \inferrule[SApp]{
    \Store, \Perm, \VEnv \vdash e_1
    \Downarrow^{#1} \Ok{\Store_1, \Perm_1, r_1} \\
    r_1 = \Loc \\
    \Store_1 (\Loc) = (\VEnv'',\lam[k]{x}{e}) \\\\
    \Perm_1' = \IF{\entail {} {k \le \kun}}{\Perm_1}{ \Perm_1\Sdel\Loc}\\
    \Store_1, \Perm_1', \VEnv \vdash e_2
    \Downarrow^{#1} \Ok{ \Store_2, \Perm_2, r_2} \\
    \Store_2, \Perm_2, \VEnv''[x\mapsto r_2] \vdash e \Downarrow^{#1}
    \Ok{\Store_3, \Perm_3, r_3}
  }{\Store, \Perm, \VEnv \vdash \app{e_1}{e_2}
    \Downarrow^{#1+1} \Ok{\Store_3,\Perm_3, r_3}
  }
}

\newcommand\ruleSLet[1][i]{%
  \inferrule[SLet]{
    \Store, \Perm, \VEnv \vdash e
    \Downarrow^{#1} \Ok{ \Store', \Perm', r} \\
    \Store', \Perm', \VEnv[x \mapsto r] \vdash e'
    \Downarrow^{#1} \Ok{ \Store'', \Perm'', r'}
  }{
    \Store, \Perm, \VEnv \vdash \letin{x}{e}{e'}
    \Downarrow^{#1+1} \Ok{\Store'', \Perm'', r'} 
  }
}

\newcommand\ruleSPair[1][i]{%
  \inferrule[SPair]{
    \Store, \Perm, \VEnv \vdash e_1
    \Downarrow^{#1} \Ok{ \Store_1, \Perm_1, r_1} \\
    \Store_1, \Perm_1, \VEnv \vdash e_2
    \Downarrow^{#1} \Ok{\Store_2, \Perm_2, r_2} \\\\
    \Loc'\notin\Dom{\Store_2} \\
    \Store_2' = \Store_2[\Loc' \mapsto \introPair[k]{r_1}{ r_2}] \\
    \Perm_2' = \Perm_2 \Sadd{\Loc'}
  }{
    \Store, \Perm, \VEnv \vdash \introPair[k]{e_1}{e_2}
    \Downarrow^{#1+1}
    \Ok{\Store_2', \Perm_2', \Loc'}
  }
}

\newcommand\ruleSMatchLocation[1][i]{%
  \inferrule[SMatchLocation]{
    \Store, \Perm, \VEnv \vdash e
    \Downarrow^{#1} \Ok{ \Store', \Perm', \Loc} \\
    \Store' (\Loc) = \introPair[k]{ \Addr'}{\Addr''} \\
    \Perm'' = \IF{\entail {} {k \le \kun}}{\Perm'}{\Perm'\Sdel\Loc} \\
    \Store', \Perm'', \VEnv[x,y \mapsto \Addr', \Addr''] \vdash e'
    \Downarrow^{#1} \Ok{\Store'', \Perm''', r''}
  }{
    \Store, \Perm, \VEnv \vdash \matchin[\text{id}]{x,y}{e}{e'} \Downarrow^{#1+1}
    \Ok{\Store'', \Perm''',  r''}
  }
}

\newcommand\ruleSMatchBorrow[1][i]{%
  \inferrule[SMatchBorrow]{
    \Store, \Perm, \VEnv \vdash e
    \Downarrow^{#1} \Ok{ \Store', \Perm', \Addr} \\
    \Addr = \Loc\Multi\BORROW\BORROW \\\\
    \Store' (\Loc) = \introPair[k]{ \Addr_l}{\Addr_r} \\
    \Addr_l' = \Addr_l\BORROW \\
    \Addr_r' = \Addr_r\BORROW \\\\
    \Perm'' = (\Perm'\Sdel{\Addr_l,\Addr_r}) \Sadd{\Addr'_l, \Addr'_r} \\
    \Store', \Perm'', \VEnv[x,y \mapsto \Addr'_l, \Addr'_r] \vdash e'
    \Downarrow^{#1} \Ok{ \Store''', \Perm''', r''}
  }{
    \Store, \Perm, \VEnv \vdash \matchin[\&^\BORROW]{x,y}{e}{e'} \Downarrow^{#1+1}
    \Ok{\Store''', (\Perm''' \Sdel{\Addr'_l, \Addr'_r}) \Sadd{\Addr_l,\Addr_r},  r''}
  }
}

\newcommand\ruleSRegion[1][i]{%
  \inferrule[SRegion]{
    \VEnv (x) = \Addr \\
    \Addr \in \Perm \\
    \Store, (\Perm \Sdel\Addr) \Sadd{\sborrow{\Addr}}, \VEnv \vdash e
    \Downarrow^{#1} \Ok{\Store', \Perm', r}
  }{
    \Store, \Perm, \VEnv \vdash \region{x}{e}
    \Downarrow^{#1+1} \Ok{ \Store', (\Perm' \Sdel{\sborrow\Addr})\Sadd\Addr, r}
  }
}

\newcommand\ruleSBorrow[1][i]{%
  \inferrule[SBorrow]{
    \VEnv (x) = \Addr \\ \sborrow\Addr \in \Perm
  }{
    \Store, \Perm, \VEnv \vdash \borrow{x}
    \Downarrow^{#1+1} \Ok{ \Store, \Perm, \sborrow\Addr}
  }
}

\newcommand\ruleSCreate[1][i]{%
  \inferrule[SCreate]{
    \Store, \Perm, \VEnv \vdash e
    \Downarrow^{#1} \Ok{ \Store', \Perm', r}\\
    \Loc\notin \Dom{\Store'} }{
    \Store, \Perm,\VEnv \vdash \create e
    \Downarrow^{#1+1} \Ok{\Store'[\Loc \mapsto \rss{r}], \Perm'\Sadd\Loc, \Loc}
  }
}

\newcommand\ruleSDestroy[1][i]{%
  \inferrule[SDestroy]{
    \Store, \Perm, \VEnv \vdash e
    \Downarrow^{#1} \Ok{ \Store', \Perm', \Loc} \\
    \Store' (\Loc) = \rss{r}
  }{
    \Store, \Perm, \VEnv \vdash \destroy e \Downarrow^{#1+1}
    \Ok{\Store'[\Loc\mapsto \blob], \Perm'\Sdel\Loc, ()}
  }
}

\newcommand\ruleSObserve[1][i]{%
  \inferrule[SObserve]{
    \Store, \Perm, \VEnv \vdash e
    \Downarrow^{#1} \Ok{ \Store', \Perm', \Addr} \\
    \Addr = \Loc\Multi\MBORROW\Multi\IBORROW\IBORROW \\
    \Addr \in \Perm' \\
    \Store' (\Loc) = \rss{r}
  }{
    \Store, \Perm, \VEnv \vdash \observe e
    \Downarrow^{#1+1} \Ok{ \Store', \Perm', r}
  }
}

\newcommand\ruleSUpdate[1][i]{%
  \inferrule[SUpdate]{
    \Store, \Perm, \VEnv \vdash e
    \Downarrow^{#1} \Ok{ \Store', \Perm', \Addr} \\
    \Addr = \Loc\Multi\MBORROW\MBORROW \\
    \Store', \Perm', \VEnv \vdash e'
    \Downarrow^{#1} \Ok{ \Store'', \Perm'', r'} \\
    \Addr \in \Perm'' \\
    \Store'' (\Loc) = \rss{r} \\
    \Store''' = \Store''[\Loc \mapsto \rss{r'}]
  }{
    \Store, \Perm, \VEnv \vdash \update e {e'}
    \Downarrow^{#1+1} \Ok{\Store''', \Perm'' \Sdel{\Addr},  ()}
  }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% syntax-directed typing
\newcommand\ruleSDLam{%
  \inferrule[Abs]
  { 
    \inferS{C}
    {\E;\bvar{x}{\tau_2}}{e}{\tau_1} \\
    \addlin{\entail{C}{\Cleq{\E}{k}}}
  }
  { \inferS{C}{\E}
    {\lam[k]{x}{e}}{\tau_2\tarr{k}\tau_1} }
}

\newcommand\ruleSDApp{%
  \inferrule[App]
  { 
    \inferS{C}{\E_1}{e_1}{\tau_2 \tarr{k} \tau_1} \\
    \inferS{C}{\E_2}{e_2}{\tau'_2} \\
    \addlin{\lsplit{C}{\E}{\E_1}{\E_2}}\\
    \entail C {\Cleq{\tau_2'}{\tau_2}} 
  }
  { \inferS{C}
    {\E}{\app{e_1}{e_2}}{\tau_1} }
}

\newcommand\ruleSDRegion{%
  \inferrule[Region]
  { \svar x {\tau_x} \in \E \\
    \addlin{ \bregion{C_r}{x}{\E}{\E'} }\\
    \inferS{C}{\E'}{e}{\tau} \\
    \inferSK{C}{\E}{\tau}{k_\tau}\\
    \entail C {C_r \Cand \Cleq{k_\tau}{\klin_{n-1}}} \\
  }  { \inferS{C}{\E}{\region{x}{e}}{\tau} }
}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:

